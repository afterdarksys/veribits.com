<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Malware Detonation Sandbox - VeriBits</title>
    <link rel="stylesheet" href="/assets/css/main.css?v=<?= time() ?>">
    <style>
        .upload-zone {
            border: 3px dashed var(--border-color);
            border-radius: 12px;
            padding: 3rem;
            text-align: center;
            transition: all 0.3s;
            cursor: pointer;
        }
        .upload-zone:hover, .upload-zone.drag-over {
            border-color: var(--primary-color);
            background: rgba(251, 191, 36, 0.05);
        }
        .threat-score {
            width: 150px;
            height: 150px;
            border-radius: 50%;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 3rem;
            font-weight: bold;
            margin: 2rem auto;
        }
        .threat-score.safe {
            background: linear-gradient(135deg, #22c55e, #16a34a);
            color: white;
        }
        .threat-score.suspicious {
            background: linear-gradient(135deg, #f59e0b, #d97706);
            color: white;
        }
        .threat-score.malicious {
            background: linear-gradient(135deg, #ef4444, #dc2626);
            color: white;
        }
        .analysis-section {
            margin: 2rem 0;
            padding: 1.5rem;
            background: var(--darker-bg);
            border-radius: 8px;
        }
        .screenshot-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 1rem;
        }
        .screenshot-item {
            border-radius: 8px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s;
        }
        .screenshot-item:hover {
            transform: scale(1.05);
        }
        .ioc-list {
            max-height: 400px;
            overflow-y: auto;
        }
        .ioc-item {
            padding: 0.75rem;
            background: rgba(255,255,255,0.02);
            border-left: 3px solid var(--primary-color);
            margin: 0.5rem 0;
            border-radius: 4px;
            font-family: monospace;
            font-size: 0.9rem;
        }
        .progress-bar {
            width: 100%;
            height: 30px;
            background: var(--darker-bg);
            border-radius: 15px;
            overflow: hidden;
            margin: 1rem 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-color), var(--accent-color));
            transition: width 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 600;
        }
    </style>
</head>
<body>
    <nav>
        <div class="container">
            <a href="/" class="logo">VeriBits</a>
            <ul>
                <li><a href="/tools.php">Tools</a></li>
                <li><a href="/cli.php">CLI</a></li>
                <li><a href="/pricing.php">Pricing</a></li>
                <li><a href="/security.php">Security</a></li>
                <li><a href="/about.php">About</a></li>
                <li data-auth-item="true"><a href="/login.php">Login</a></li>
                <li data-auth-item="true"><a href="/signup.php" class="btn btn-primary">Sign Up</a></li>
            </ul>
        </div>
    </nav>

    <section style="padding: 8rem 2rem 4rem;">
        <div class="container" style="max-width: 1200px;">
            <div style="text-align: center;">
                <div style="display: inline-block; background: linear-gradient(135deg, #667eea, #764ba2); color: white; padding: 0.4rem 1rem; border-radius: 20px; font-size: 0.85rem; font-weight: bold; margin-bottom: 1rem; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);">
                    ‚≠ê ENTERPRISE FEATURE
                </div>
            </div>
            <h1 style="font-size: 3rem; margin-bottom: 1rem; text-align: center;">ü¶† Malware Detonation Sandbox</h1>
            <p style="text-align: center; color: var(--text-secondary); margin-bottom: 3rem;">
                Automated dynamic malware analysis powered by Cuckoo Sandbox
            </p>

            <div id="alert-container"></div>

            <!-- Upload Section -->
            <div id="upload-section" class="feature-card">
                <h2 style="margin-bottom: 1.5rem;">Submit File for Analysis</h2>

                <div class="upload-zone" id="upload-zone">
                    <div style="font-size: 4rem; margin-bottom: 1rem;">üìÅ</div>
                    <h3>Drop file here or click to browse</h3>
                    <p style="color: var(--text-secondary); margin-top: 1rem;">
                        Max 100MB ‚Ä¢ Executables, PDFs, Office documents, Archives
                    </p>
                    <input type="file" id="file-input" style="display: none;">
                </div>

                <div style="margin-top: 2rem;" id="file-info" style="display: none;">
                    <div style="padding: 1rem; background: rgba(251, 191, 36, 0.1); border-radius: 8px;">
                        <strong>üìÑ Selected File:</strong> <span id="file-name"></span><br>
                        <strong>üìä Size:</strong> <span id="file-size"></span><br>
                        <strong>üîê SHA-256:</strong> <span id="file-hash" style="font-family: monospace; font-size: 0.9rem;"></span>
                    </div>
                </div>

                <!-- Analysis Options -->
                <div style="margin-top: 2rem;">
                    <h3 style="margin-bottom: 1rem;">Analysis Options</h3>

                    <div class="form-group">
                        <label>Priority</label>
                        <select id="priority" class="form-control">
                            <option value="1">Low - Standard queue (slower)</option>
                            <option value="2" selected>Medium - Normal processing</option>
                            <option value="3">High - Express analysis (Pro only)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label>Timeout (seconds)</label>
                        <input type="number" id="timeout" value="120" min="60" max="600" class="form-control">
                        <small style="display: block; margin-top: 0.5rem; color: var(--text-secondary);">
                            How long to run the analysis (60-600 seconds)
                        </small>
                    </div>

                    <div class="form-group">
                        <label>
                            <input type="checkbox" id="enable-network">
                            Enable Network (allow outbound connections)
                        </label>
                        <small style="display: block; margin-left: 1.5rem; color: var(--text-secondary);">
                            ‚ö†Ô∏è May allow malware to communicate with C2 servers
                        </small>
                    </div>

                    <button class="btn btn-primary" onclick="submitForAnalysis()" style="width: 100%; margin-top: 1rem;" disabled id="submit-btn">
                        üöÄ Start Analysis
                    </button>
                </div>
            </div>

            <!-- Progress Section -->
            <div id="progress-section" class="feature-card" style="display: none;">
                <h2 style="margin-bottom: 1.5rem;">Analysis in Progress</h2>

                <div id="progress-status">
                    <p style="text-align: center; font-size: 1.2rem; margin-bottom: 1rem;">
                        <span id="status-text">Uploading file...</span>
                    </p>

                    <div class="progress-bar">
                        <div class="progress-fill" id="progress-fill" style="width: 0%;">
                            <span id="progress-percent">0%</span>
                        </div>
                    </div>

                    <p style="text-align: center; color: var(--text-secondary); margin-top: 1rem;">
                        Submission ID: <strong id="submission-id"></strong>
                    </p>
                </div>
            </div>

            <!-- Results Section -->
            <div id="results-section" class="feature-card" style="display: none;">
                <h2 style="margin-bottom: 2rem;">Analysis Results</h2>

                <!-- Threat Score -->
                <div style="text-align: center;">
                    <div class="threat-score" id="threat-score">
                        <span id="score-value">-</span>
                    </div>
                    <h3 id="threat-label">Analyzing...</h3>
                </div>

                <!-- Tabs -->
                <div class="tab-container" style="margin-top: 3rem;">
                    <button class="tab active" onclick="switchResultTab('overview')">üìä Overview</button>
                    <button class="tab" onclick="switchResultTab('behavior')">üî¨ Behavior</button>
                    <button class="tab" onclick="switchResultTab('network')">üåê Network</button>
                    <button class="tab" onclick="switchResultTab('screenshots')">üì∏ Screenshots</button>
                    <button class="tab" onclick="switchResultTab('iocs')">üéØ IOCs</button>
                </div>

                <!-- Tab Content -->
                <div id="overview-tab" class="tab-content active">
                    <div class="analysis-section" id="overview-content"></div>
                </div>

                <div id="behavior-tab" class="tab-content">
                    <div class="analysis-section" id="behavior-content"></div>
                </div>

                <div id="network-tab" class="tab-content">
                    <div class="analysis-section" id="network-content"></div>
                </div>

                <div id="screenshots-tab" class="tab-content">
                    <div class="analysis-section">
                        <div class="screenshot-grid" id="screenshots-grid"></div>
                    </div>
                </div>

                <div id="iocs-tab" class="tab-content">
                    <div class="analysis-section">
                        <div id="iocs-content"></div>
                    </div>
                </div>

                <!-- Actions -->
                <div style="margin-top: 2rem; display: flex; gap: 1rem;">
                    <button class="btn btn-secondary" onclick="downloadReport('json')">
                        üíæ Download JSON Report
                    </button>
                    <button class="btn btn-secondary" onclick="downloadReport('pdf')">
                        üìÑ Download PDF Report
                    </button>
                    <button class="btn btn-secondary" onclick="downloadPCAP()">
                        üì° Download PCAP
                    </button>
                    <button class="btn btn-primary" onclick="resetAnalysis()">
                        üîÑ Analyze Another File
                    </button>
                </div>
            </div>

            <!-- Information -->
            <div class="feature-card" style="margin-top: 2rem;">
                <h2 style="margin-bottom: 1.5rem;">About Malware Detonation</h2>

                <h3 style="color: var(--accent-color); margin-top: 1.5rem; margin-bottom: 0.75rem;">What is Dynamic Analysis?</h3>
                <p>
                    Dynamic analysis executes suspicious files in an isolated sandbox environment (virtual machine)
                    to observe their behavior. This reveals malicious activities that static analysis might miss.
                </p>

                <h3 style="color: var(--accent-color); margin-top: 1.5rem; margin-bottom: 0.75rem;">What We Analyze</h3>
                <ul style="margin-left: 1.5rem;">
                    <li>Process creation and execution</li>
                    <li>File system modifications</li>
                    <li>Registry changes (Windows)</li>
                    <li>Network connections and DNS queries</li>
                    <li>HTTP/HTTPS traffic</li>
                    <li>API calls and system interactions</li>
                </ul>

                <h3 style="color: var(--accent-color); margin-top: 1.5rem; margin-bottom: 0.75rem;">Safety & Isolation</h3>
                <ul style="margin-left: 1.5rem;">
                    <li>‚úÖ Executed in isolated VM (complete isolation)</li>
                    <li>‚úÖ No access to production systems</li>
                    <li>‚úÖ Network traffic monitored and logged</li>
                    <li>‚úÖ VM reset after each analysis</li>
                </ul>
            </div>
        </div>
    </section>

    <footer>
        <div class="container">
            <p>&copy; 2025 VeriBits by After Dark Systems. All rights reserved.</p>
        </div>
    </footer>

    <script src="/assets/js/main.js?v=<?= time() ?>"></script>
    <script>
        let currentSubmissionId = null;
        let pollingInterval = null;
        let selectedFile = null;

        // File upload handling
        const uploadZone = document.getElementById('upload-zone');
        const fileInput = document.getElementById('file-input');

        uploadZone.addEventListener('click', () => fileInput.click());

        uploadZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadZone.classList.add('drag-over');
        });

        uploadZone.addEventListener('dragleave', () => {
            uploadZone.classList.remove('drag-over');
        });

        uploadZone.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadZone.classList.remove('drag-over');
            handleFile(e.dataTransfer.files[0]);
        });

        fileInput.addEventListener('change', (e) => {
            handleFile(e.target.files[0]);
        });

        async function handleFile(file) {
            if (!file) return;

            selectedFile = file;

            // Calculate hash
            const arrayBuffer = await file.arrayBuffer();
            const hashBuffer = await crypto.subtle.digest('SHA-256', arrayBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            const hashHex = hashArray.map(b => b.toString(16).padStart(2, '0')).join('');

            // Display file info
            document.getElementById('file-name').textContent = file.name;
            document.getElementById('file-size').textContent = formatBytes(file.size);
            document.getElementById('file-hash').textContent = hashHex;
            document.getElementById('file-info').style.display = 'block';
            document.getElementById('submit-btn').disabled = false;
        }

        async function submitForAnalysis() {
            if (!selectedFile) return;

            const formData = new FormData();
            formData.append('file', selectedFile);
            formData.append('priority', document.getElementById('priority').value);
            formData.append('timeout', document.getElementById('timeout').value);
            formData.append('enable_network', document.getElementById('enable-network').checked);

            document.getElementById('upload-section').style.display = 'none';
            document.getElementById('progress-section').style.display = 'block';

            try {
                const response = await fetch('/api/v1/malware/submit', {
                    method: 'POST',
                    headers: {
                        'Authorization': 'Bearer ' + getAuthToken()
                    },
                    body: formData
                });

                const result = await response.json();

                if (result.success) {
                    currentSubmissionId = result.data.submission_id;
                    document.getElementById('submission-id').textContent = currentSubmissionId;

                    // Start polling for status
                    startStatusPolling();
                } else {
                    showAlert(result.error.message, 'error');
                    resetAnalysis();
                }
            } catch (error) {
                showAlert('Upload failed: ' + error.message, 'error');
                resetAnalysis();
            }
        }

        function startStatusPolling() {
            pollingInterval = setInterval(checkStatus, 3000);
            checkStatus();
        }

        async function checkStatus() {
            try {
                const result = await apiRequest(`/malware/status/${currentSubmissionId}`);

                const status = result.data.status;
                updateProgress(status);

                if (status === 'reported') {
                    clearInterval(pollingInterval);
                    loadReport();
                } else if (status === 'failed') {
                    clearInterval(pollingInterval);
                    showAlert('Analysis failed', 'error');
                    resetAnalysis();
                }
            } catch (error) {
                console.error('Status check failed:', error);
            }
        }

        function updateProgress(status) {
            const statusMap = {
                'pending': { text: 'Queued...', percent: 10 },
                'running': { text: 'Analyzing...', percent: 50 },
                'reported': { text: 'Complete!', percent: 100 },
                'failed': { text: 'Failed', percent: 0 }
            };

            const info = statusMap[status] || statusMap['pending'];
            document.getElementById('status-text').textContent = info.text;
            document.getElementById('progress-fill').style.width = info.percent + '%';
            document.getElementById('progress-percent').textContent = info.percent + '%';
        }

        async function loadReport() {
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'block';

            try {
                const result = await apiRequest(`/malware/report/${currentSubmissionId}`);
                displayResults(result.data);
            } catch (error) {
                showAlert('Failed to load report: ' + error.message, 'error');
            }
        }

        function displayResults(report) {
            // Threat score
            const score = report.info?.score || 0;
            document.getElementById('score-value').textContent = score;

            const scoreEl = document.getElementById('threat-score');
            const labelEl = document.getElementById('threat-label');

            if (score < 3) {
                scoreEl.className = 'threat-score safe';
                labelEl.textContent = '‚úÖ Safe / Low Risk';
            } else if (score < 7) {
                scoreEl.className = 'threat-score suspicious';
                labelEl.textContent = '‚ö†Ô∏è Suspicious';
            } else {
                scoreEl.className = 'threat-score malicious';
                labelEl.textContent = 'üö® Malicious';
            }

            // Overview
            document.getElementById('overview-content').innerHTML = generateOverview(report);

            // Other tabs loaded on demand
        }

        function generateOverview(report) {
            return `
                <h3>File Information</h3>
                <div style="margin-bottom: 1rem;">
                    <strong>Name:</strong> ${report.target?.file?.name || 'Unknown'}<br>
                    <strong>Type:</strong> ${report.target?.file?.type || 'Unknown'}<br>
                    <strong>Size:</strong> ${formatBytes(report.target?.file?.size || 0)}<br>
                    <strong>MD5:</strong> <code>${report.target?.file?.md5 || 'N/A'}</code><br>
                    <strong>SHA256:</strong> <code>${report.target?.file?.sha256 || 'N/A'}</code>
                </div>

                <h3>Analysis Summary</h3>
                <div>
                    <strong>Duration:</strong> ${report.info?.duration || 0} seconds<br>
                    <strong>Signatures Matched:</strong> ${report.signatures?.length || 0}<br>
                    <strong>Network Activity:</strong> ${report.network?.tcp?.length || 0} connections<br>
                    <strong>Files Created:</strong> ${report.behavior?.summary?.files?.length || 0}
                </div>
            `;
        }

        function switchResultTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            event.target.classList.add('active');

            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            document.getElementById(tab + '-tab').classList.add('active');
        }

        function downloadReport(format) {
            window.location.href = `/api/v1/malware/report/${currentSubmissionId}?format=${format}`;
        }

        function downloadPCAP() {
            window.location.href = `/api/v1/malware/pcap/${currentSubmissionId}`;
        }

        function resetAnalysis() {
            currentSubmissionId = null;
            selectedFile = null;
            document.getElementById('upload-section').style.display = 'block';
            document.getElementById('progress-section').style.display = 'none';
            document.getElementById('results-section').style.display = 'none';
            document.getElementById('file-info').style.display = 'none';
            document.getElementById('submit-btn').disabled = true;
            fileInput.value = '';
        }

        function formatBytes(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return Math.round(bytes / Math.pow(k, i) * 100) / 100 + ' ' + sizes[i];
        }

        function getAuthToken() {
            return localStorage.getItem('token') || '';
        }
    </script>
</body>
</html>
