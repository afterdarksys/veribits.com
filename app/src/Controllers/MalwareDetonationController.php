<?php

namespace VeriBits\Controllers;

use VeriBits\Utils\Response;
use VeriBits\Utils\Database;
use VeriBits\Utils\Auth;
use VeriBits\Utils\RateLimiter;

class MalwareDetonationController extends BaseController
{
    private const CUCKOO_API_URL = 'http://localhost:8090'; // Cuckoo API endpoint
    private const MAX_FILE_SIZE = 104857600; // 100MB
    private const ALLOWED_MIME_TYPES = [
        'application/x-dosexec',
        'application/x-executable',
        'application/vnd.microsoft.portable-executable',
        'application/x-msdos-program',
        'application/x-msdownload',
        'application/pdf',
        'application/zip',
        'application/x-zip-compressed',
        'application/vnd.ms-office',
        'application/msword',
        'application/vnd.openxmlformats-officedocument'
    ];

    /**
     * Submit file for malware analysis
     * POST /api/v1/malware/submit
     */
    public function submit(): void
    {
        $user = Auth::requireAuth();

        // Rate limiting
        if (!RateLimiter::check('malware_submit', 10, 3600)) {
            Response::error('Rate limit exceeded. Max 10 submissions per hour.', 429);
            return;
        }

        // Check file upload
        if (!isset($_FILES['file'])) {
            Response::error('No file uploaded', 400);
            return;
        }

        $file = $_FILES['file'];

        // Validate file
        if ($file['error'] !== UPLOAD_ERR_OK) {
            Response::error('File upload error', 400);
            return;
        }

        if ($file['size'] > self::MAX_FILE_SIZE) {
            Response::error('File too large. Max ' . (self::MAX_FILE_SIZE / 1024 / 1024) . 'MB', 400);
            return;
        }

        // Get options
        $priority = (int) ($_POST['priority'] ?? 1); // 1-3
        $timeout = min((int) ($_POST['timeout'] ?? 120), 600); // Max 10 minutes
        $enableNetwork = (bool) ($_POST['enable_network'] ?? false);
        $options = $_POST['options'] ?? [];

        // Calculate file hash
        $fileHash = hash_file('sha256', $file['tmp_name']);

        // Check if already analyzed
        $existingAnalysis = $this->getExistingAnalysis($fileHash);
        if ($existingAnalysis && ($_POST['force_reanalyze'] ?? false) !== true) {
            Response::success([
                'submission_id' => $existingAnalysis['id'],
                'status' => 'cached',
                'message' => 'File already analyzed. Use force_reanalyze=true to submit again.',
                'analysis_url' => "/malware/report/{$existingAnalysis['id']}"
            ]);
            return;
        }

        // Submit to Cuckoo
        try {
            $cuckooTaskId = $this->submitToCuckoo(
                $file['tmp_name'],
                $file['name'],
                $timeout,
                $priority,
                $enableNetwork,
                $options
            );

            // Store in database
            $db = Database::getInstance();
            $stmt = $db->prepare('
                INSERT INTO malware_submissions
                (user_id, file_name, file_hash, file_size, cuckoo_task_id, status, priority, timeout, enable_network, submitted_at)
                VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, NOW())
            ');
            $stmt->execute([
                $user['id'],
                $file['name'],
                $fileHash,
                $file['size'],
                $cuckooTaskId,
                'pending',
                $priority,
                $timeout,
                $enableNetwork ? 1 : 0
            ]);

            $submissionId = $db->lastInsertId();

            // Trigger webhook
            WebhooksController::trigger('malware.submitted', [
                'submission_id' => $submissionId,
                'file_name' => $file['name'],
                'file_hash' => $fileHash
            ]);

            Response::success([
                'submission_id' => $submissionId,
                'cuckoo_task_id' => $cuckooTaskId,
                'file_hash' => $fileHash,
                'status' => 'pending',
                'estimated_time' => $timeout . ' seconds',
                'check_status_url' => "/api/v1/malware/status/$submissionId"
            ], 202);

        } catch (\Exception $e) {
            Response::error('Failed to submit to sandbox: ' . $e->getMessage(), 500);
        }
    }

    /**
     * Check submission status
     * GET /api/v1/malware/status/{id}
     */
    public function status(): void
    {
        $user = Auth::requireAuth();
        $submissionId = $this->getPathParam(4);

        $db = Database::getInstance();
        $stmt = $db->prepare('
            SELECT id, file_name, file_hash, cuckoo_task_id, status, priority, submitted_at, completed_at
            FROM malware_submissions
            WHERE id = ? AND user_id = ?
        ');
        $stmt->execute([$submissionId, $user['id']]);
        $submission = $stmt->fetch();

        if (!$submission) {
            Response::error('Submission not found', 404);
            return;
        }

        // If pending, check Cuckoo status
        if ($submission['status'] === 'pending') {
            try {
                $cuckooStatus = $this->getCuckooTaskStatus($submission['cuckoo_task_id']);

                // Update status if changed
                if ($cuckooStatus['status'] !== 'pending') {
                    $this->updateSubmissionStatus($submissionId, $cuckooStatus['status']);
                    $submission['status'] = $cuckooStatus['status'];
                }

                $submission['cuckoo_status'] = $cuckooStatus;
            } catch (\Exception $e) {
                // Cuckoo might be unavailable
                $submission['cuckoo_status'] = ['error' => $e->getMessage()];
            }
        }

        Response::success($submission);
    }

    /**
     * Get analysis report
     * GET /api/v1/malware/report/{id}
     */
    public function report(): void
    {
        $user = Auth::requireAuth();
        $submissionId = $this->getPathParam(4);
        $format = $_GET['format'] ?? 'json'; // json, html, pdf

        $db = Database::getInstance();
        $stmt = $db->prepare('
            SELECT id, file_name, file_hash, cuckoo_task_id, status
            FROM malware_submissions
            WHERE id = ? AND user_id = ?
        ');
        $stmt->execute([$submissionId, $user['id']]);
        $submission = $stmt->fetch();

        if (!$submission) {
            Response::error('Submission not found', 404);
            return;
        }

        if ($submission['status'] !== 'reported') {
            Response::error('Analysis not complete yet', 425);
            return;
        }

        try {
            $report = $this->getCuckooReport($submission['cuckoo_task_id'], $format);

            if ($format === 'json') {
                Response::success($report);
            } elseif ($format === 'html') {
                header('Content-Type: text/html');
                echo $report;
            } elseif ($format === 'pdf') {
                header('Content-Type: application/pdf');
                header('Content-Disposition: attachment; filename="malware-report-' . $submissionId . '.pdf"');
                echo $report;
            }
        } catch (\Exception $e) {
            Response::error('Failed to retrieve report: ' . $e->getMessage(), 500);
        }
    }

    /**
     * Get screenshots
     * GET /api/v1/malware/screenshots/{id}
     */
    public function screenshots(): void
    {
        $user = Auth::requireAuth();
        $submissionId = $this->getPathParam(4);

        $submission = $this->getSubmission($submissionId, $user['id']);
        if (!$submission || $submission['status'] !== 'reported') {
            Response::error('Screenshots not available', 404);
            return;
        }

        try {
            $screenshots = $this->getCuckooScreenshots($submission['cuckoo_task_id']);
            Response::success(['screenshots' => $screenshots]);
        } catch (\Exception $e) {
            Response::error('Failed to retrieve screenshots: ' . $e->getMessage(), 500);
        }
    }

    /**
     * Get PCAP (network capture)
     * GET /api/v1/malware/pcap/{id}
     */
    public function pcap(): void
    {
        $user = Auth::requireAuth();
        $submissionId = $this->getPathParam(4);

        $submission = $this->getSubmission($submissionId, $user['id']);
        if (!$submission || $submission['status'] !== 'reported') {
            Response::error('PCAP not available', 404);
            return;
        }

        try {
            $pcap = $this->getCuckooPCAP($submission['cuckoo_task_id']);

            header('Content-Type: application/vnd.tcpdump.pcap');
            header('Content-Disposition: attachment; filename="capture-' . $submissionId . '.pcap"');
            echo $pcap;
        } catch (\Exception $e) {
            Response::error('Failed to retrieve PCAP: ' . $e->getMessage(), 500);
        }
    }

    /**
     * Extract IOCs (Indicators of Compromise)
     * GET /api/v1/malware/iocs/{id}
     */
    public function iocs(): void
    {
        $user = Auth::requireAuth();
        $submissionId = $this->getPathParam(4);

        $submission = $this->getSubmission($submissionId, $user['id']);
        if (!$submission || $submission['status'] !== 'reported') {
            Response::error('IOCs not available', 404);
            return;
        }

        try {
            $report = $this->getCuckooReport($submission['cuckoo_task_id'], 'json');

            // Extract IOCs from report
            $iocs = [
                'ips' => $this->extractIPs($report),
                'domains' => $this->extractDomains($report),
                'urls' => $this->extractURLs($report),
                'file_hashes' => $this->extractFileHashes($report),
                'registry_keys' => $this->extractRegistryKeys($report),
                'mutexes' => $this->extractMutexes($report)
            ];

            Response::success($iocs);
        } catch (\Exception $e) {
            Response::error('Failed to extract IOCs: ' . $e->getMessage(), 500);
        }
    }

    // ========== CUCKOO INTEGRATION ==========

    /**
     * Submit file to Cuckoo Sandbox
     */
    private function submitToCuckoo(
        string $filePath,
        string $fileName,
        int $timeout,
        int $priority,
        bool $enableNetwork,
        array $options
    ): int {
        $url = self::CUCKOO_API_URL . '/tasks/create/file';

        $cfile = new \CURLFile($filePath, mime_content_type($filePath), $fileName);

        $postData = [
            'file' => $cfile,
            'timeout' => $timeout,
            'priority' => $priority,
            'options' => implode(',', $options)
        ];

        if (!$enableNetwork) {
            $postData['options'] .= ',free=no';
        }

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_POST, true);
        curl_setopt($ch, CURLOPT_POSTFIELDS, $postData);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $response = curl_exec($ch);
        $httpCode = curl_getinfo($ch, CURLINFO_HTTP_CODE);
        curl_close($ch);

        if ($httpCode !== 200) {
            throw new \Exception("Cuckoo API error: HTTP $httpCode");
        }

        $result = json_decode($response, true);
        if (!isset($result['task_id'])) {
            throw new \Exception('Invalid Cuckoo response');
        }

        return $result['task_id'];
    }

    /**
     * Get task status from Cuckoo
     */
    private function getCuckooTaskStatus(int $taskId): array
    {
        $url = self::CUCKOO_API_URL . '/tasks/view/' . $taskId;

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $response = curl_exec($ch);
        curl_close($ch);

        $result = json_decode($response, true);

        return [
            'status' => $result['task']['status'] ?? 'unknown',
            'progress' => $result['task']['progress'] ?? 0
        ];
    }

    /**
     * Get analysis report from Cuckoo
     */
    private function getCuckooReport(int $taskId, string $format): mixed
    {
        $url = self::CUCKOO_API_URL . '/tasks/report/' . $taskId . '/' . $format;

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $response = curl_exec($ch);
        curl_close($ch);

        if ($format === 'json') {
            return json_decode($response, true);
        }

        return $response;
    }

    /**
     * Get screenshots from Cuckoo
     */
    private function getCuckooScreenshots(int $taskId): array
    {
        $url = self::CUCKOO_API_URL . '/tasks/screenshots/' . $taskId;

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $response = curl_exec($ch);
        curl_close($ch);

        $result = json_decode($response, true);

        $screenshots = [];
        foreach ($result as $screenshot) {
            $screenshots[] = [
                'id' => $screenshot['id'],
                'path' => $screenshot['path'],
                'url' => self::CUCKOO_API_URL . $screenshot['path']
            ];
        }

        return $screenshots;
    }

    /**
     * Get PCAP from Cuckoo
     */
    private function getCuckooPCAP(int $taskId): string
    {
        $url = self::CUCKOO_API_URL . '/pcap/get/' . $taskId;

        $ch = curl_init();
        curl_setopt($ch, CURLOPT_URL, $url);
        curl_setopt($ch, CURLOPT_RETURNTRANSFER, true);

        $pcap = curl_exec($ch);
        curl_close($ch);

        return $pcap;
    }

    // ========== IOC EXTRACTION ==========

    private function extractIPs(array $report): array
    {
        $ips = [];
        if (isset($report['network']['tcp'])) {
            foreach ($report['network']['tcp'] as $conn) {
                $ips[] = $conn['dst'];
            }
        }
        if (isset($report['network']['udp'])) {
            foreach ($report['network']['udp'] as $conn) {
                $ips[] = $conn['dst'];
            }
        }
        return array_unique($ips);
    }

    private function extractDomains(array $report): array
    {
        $domains = [];
        if (isset($report['network']['domains'])) {
            foreach ($report['network']['domains'] as $domain) {
                $domains[] = $domain['domain'];
            }
        }
        return array_unique($domains);
    }

    private function extractURLs(array $report): array
    {
        $urls = [];
        if (isset($report['network']['http'])) {
            foreach ($report['network']['http'] as $http) {
                $urls[] = $http['uri'];
            }
        }
        return array_unique($urls);
    }

    private function extractFileHashes(array $report): array
    {
        $hashes = [];
        if (isset($report['dropped'])) {
            foreach ($report['dropped'] as $file) {
                $hashes[] = [
                    'md5' => $file['md5'],
                    'sha1' => $file['sha1'],
                    'sha256' => $file['sha256']
                ];
            }
        }
        return $hashes;
    }

    private function extractRegistryKeys(array $report): array
    {
        $keys = [];
        if (isset($report['behavior']['summary']['keys'])) {
            $keys = $report['behavior']['summary']['keys'];
        }
        return $keys;
    }

    private function extractMutexes(array $report): array
    {
        $mutexes = [];
        if (isset($report['behavior']['summary']['mutexes'])) {
            $mutexes = $report['behavior']['summary']['mutexes'];
        }
        return $mutexes;
    }

    // ========== HELPER METHODS ==========

    private function getSubmission(int $id, int $userId): ?array
    {
        $db = Database::getInstance();
        $stmt = $db->prepare('
            SELECT *
            FROM malware_submissions
            WHERE id = ? AND user_id = ?
        ');
        $stmt->execute([$id, $userId]);
        return $stmt->fetch() ?: null;
    }

    private function getExistingAnalysis(string $fileHash): ?array
    {
        $db = Database::getInstance();
        $stmt = $db->prepare('
            SELECT id, status
            FROM malware_submissions
            WHERE file_hash = ? AND status = ?
            ORDER BY submitted_at DESC
            LIMIT 1
        ');
        $stmt->execute([$fileHash, 'reported']);
        return $stmt->fetch() ?: null;
    }

    private function updateSubmissionStatus(int $id, string $status): void
    {
        $db = Database::getInstance();
        $stmt = $db->prepare('UPDATE malware_submissions SET status = ?, completed_at = NOW() WHERE id = ?');
        $stmt->execute([$status, $id]);
    }

    private function getPathParam(int $index): ?string
    {
        $path = parse_url($_SERVER['REQUEST_URI'], PHP_URL_PATH);
        $parts = explode('/', trim($path, '/'));
        return $parts[$index] ?? null;
    }
}
