# DNS Migration Converter - VeriBits

## Overview

The DNS Migration Converter is a comprehensive tool for migrating DNS server configurations between different DNS server software platforms. It supports two major migration paths:

1. **djbdns/dnscache → Unbound** (with optional tinydns → NSD)
2. **BIND → NSD**

## Features

### djbdns to Unbound Converter

#### What it Does
- Parses djbdns/dnscache directory structure from uploaded tar.gz archive
- Extracts upstream DNS servers from `root/servers/*`
- Converts allowed client IPs from `root/ip/*`
- Reads environment variables from `env/` directory
- Generates complete `unbound.conf` with:
  - Modern security settings (hide-identity, hide-version, DNSSEC validation)
  - Optimized cache parameters
  - Access control lists
  - Forward zones configuration
  - IPv4 and IPv6 support
- **Bonus**: Optionally converts tinydns `data` file to NSD zone format

#### Supported djbdns Structure
```
/var/dnscache/
├── root/
│   ├── servers/
│   │   ├── @           # Root servers (becomes forward-zone: ".")
│   │   └── example.com  # Specific zone forwards
│   └── ip/
│       ├── 127.0.0.1    # Allowed client IPs
│       └── 192.168.1.0
└── env/
    └── CACHESIZE        # Cache size in bytes
```

#### Generated Unbound Configuration

The tool generates a production-ready `unbound.conf` with:

```conf
server:
    # Network settings
    interface: 0.0.0.0
    interface: ::
    port: 53
    do-ip4: yes
    do-ip6: yes
    do-udp: yes
    do-tcp: yes

    # Access control (from root/ip/*)
    access-control: 127.0.0.0/8 allow
    access-control: 192.168.1.0/24 allow
    access-control: 0.0.0.0/0 refuse
    access-control: ::/0 refuse

    # Performance settings (from env/CACHESIZE)
    num-threads: 2
    msg-cache-size: 50m
    rrset-cache-size: 50m
    cache-min-ttl: 3600
    cache-max-ttl: 86400

    # Security settings
    hide-identity: yes
    hide-version: yes
    harden-glue: yes
    harden-dnssec-stripped: yes
    use-caps-for-id: yes
    private-address: 10.0.0.0/8
    private-address: 172.16.0.0/12
    private-address: 192.168.0.0/16

    # DNSSEC validation
    auto-trust-anchor-file: "/var/lib/unbound/root.key"
    val-clean-additional: yes

forward-zone:
    name: "."
    forward-addr: 8.8.8.8
    forward-addr: 8.8.4.4
```

### tinydns to NSD Converter

When enabled, the tool also converts tinydns `data` files to NSD zone format.

#### Supported tinydns Record Types

| tinydns | Description | Converts to |
|---------|-------------|-------------|
| `.` | NS + A (SOA implied) | SOA + NS + A |
| `&` | NS + A | NS + A |
| `+` | A record | A |
| `=` | A + PTR | A |
| `@` | MX record | MX |
| `'` | TXT record | TXT |
| `C` | CNAME record | CNAME |
| `^` | PTR record | PTR |

#### Example tinydns Data
```
# tinydns data file
.example.com:192.168.1.1:ns1.example.com:86400
+www.example.com:192.168.1.10:3600
@example.com:192.168.1.20:10:3600
```

#### Generated NSD Zone
```zone
; Zone file for example.com
; Generated by VeriBits DNS Converter
$ORIGIN example.com.
$TTL 3600

@    IN    SOA    ns1.example.com. hostmaster.example.com. (
                    2025102701    ; serial
                    3600          ; refresh
                    900           ; retry
                    604800        ; expire
                    86400 )       ; minimum

@                    IN    NS    ns1.example.com.
ns1                  IN    A     192.168.1.1
www                  IN    A     192.168.1.10
@                    IN    MX    10 192.168.1.20
```

### BIND to NSD Converter

#### What it Does
- Parses `named.conf` configuration file
- Extracts zone definitions (master/slave/stub)
- Converts TSIG keys for secure zone transfers
- Generates `nsd.conf` with modern NSD best practices
- Validates and converts zone files to NSD format
- Preserves all DNS records and zone data
- Handles zone transfer configurations

#### Supported BIND Configuration

```conf
# named.conf example
key "transfer-key" {
    algorithm hmac-sha256;
    secret "base64secret==";
};

zone "example.com" {
    type master;
    file "/var/named/example.com.zone";
    allow-transfer { 192.168.1.2; key transfer-key; };
};

zone "slave.example.com" {
    type slave;
    masters { 192.168.1.1; };
    file "/var/named/slave.example.com.zone";
};
```

#### Generated NSD Configuration

```conf
server:
    server-count: 2
    ip-address: 0.0.0.0
    ip-address: ::
    port: 53
    do-ip4: yes
    do-ip6: yes
    hide-version: yes
    identity: ""
    zonesdir: "/etc/nsd/zones"
    logfile: "/var/log/nsd.log"
    pidfile: "/var/run/nsd.pid"

key:
    name: "transfer-key"
    algorithm: hmac-sha256
    secret: "base64secret=="

zone:
    name: "example.com"
    zonefile: "example.com.zone"
    notify: 192.168.1.2 NOKEY
    provide-xfr: 0.0.0.0/0 NOKEY

zone:
    name: "slave.example.com"
    zonefile: "slave.example.com.zone"
    request-xfr: 192.168.1.1 NOKEY
```

## API Endpoints

### Convert djbdns/dnscache to Unbound

**Endpoint**: `POST /api/v1/dns-converter/dnscache-to-unbound`

**Request**:
- Method: `POST`
- Content-Type: `multipart/form-data`
- Body:
  - `archive`: tar.gz or zip file containing dnscache directory structure
  - `convert_tinydns`: `true` or `false` (optional, defaults to false)

**Response**:
```json
{
  "status": "success",
  "message": "DNS configuration converted successfully",
  "data": {
    "unbound_conf": "# Generated Unbound configuration...",
    "nsd_conf": "# Generated NSD configuration (if tinydns conversion enabled)...",
    "zone_files": {
      "example.com": "; Zone file content..."
    },
    "config_details": {
      "upstream_servers": {
        ".": ["8.8.8.8", "8.8.4.4"]
      },
      "client_ips": ["127.0.0.1", "192.168.1.0"],
      "cache_size": "50m",
      "num_threads": 2
    }
  }
}
```

### Convert BIND to NSD

**Endpoint**: `POST /api/v1/dns-converter/bind-to-nsd`

**Request**:
- Method: `POST`
- Content-Type: `multipart/form-data`
- Body:
  - `archive`: tar.gz or zip file containing named.conf and zone files

**Response**:
```json
{
  "status": "success",
  "message": "BIND configuration converted to NSD successfully",
  "data": {
    "nsd_conf": "# Generated NSD configuration...",
    "zones": {
      "example.com": {
        "content": "; Zone file content...",
        "type": "master",
        "original_file": "/var/named/example.com.zone"
      }
    },
    "config_details": {
      "total_zones": 5,
      "master_zones": 3,
      "slave_zones": 2,
      "tsig_keys": 1
    }
  }
}
```

## Usage Guide

### Web Interface

1. **Navigate to the Tool**
   - Access: `/tool/dns-converter.php`

2. **Select Conversion Type**
   - Tab 1: djbdns → Unbound
   - Tab 2: BIND → NSD

3. **Upload Configuration Archive**
   - Drag and drop or click to browse
   - Supported formats: `.tar.gz`, `.tgz`, `.zip`

4. **Configure Options**
   - For djbdns: Enable "Also convert tinydns data file" if needed

5. **Convert**
   - Click "Convert to Unbound" or "Convert to NSD"
   - Review generated configurations

6. **Download**
   - Download individual configuration files
   - Download zone files separately

### CLI Usage (via API)

#### djbdns to Unbound
```bash
# Create archive of dnscache directory
tar czf dnscache.tar.gz /var/dnscache/

# Convert using API
curl -X POST \
  -F "archive=@dnscache.tar.gz" \
  -F "convert_tinydns=true" \
  -H "X-API-Key: your-api-key" \
  https://veribits.com/api/v1/dns-converter/dnscache-to-unbound \
  | jq -r '.data.unbound_conf' > unbound.conf
```

#### BIND to NSD
```bash
# Create archive with BIND config
mkdir bind-config
cp /etc/named.conf bind-config/
cp -r /var/named/*.zone bind-config/
tar czf bind-config.tar.gz bind-config/

# Convert using API
curl -X POST \
  -F "archive=@bind-config.tar.gz" \
  -H "X-API-Key: your-api-key" \
  https://veribits.com/api/v1/dns-converter/bind-to-nsd \
  | jq -r '.data.nsd_conf' > nsd.conf
```

## Implementation Details

### Controller: DnsConverterController.php

**Location**: `/app/src/Controllers/DnsConverterController.php`

**Key Methods**:

- `convertDnscache()`: Main entry point for djbdns conversion
- `convertBind()`: Main entry point for BIND conversion
- `parseDnscacheConfig()`: Parse djbdns directory structure
- `parseTinydnsData()`: Parse tinydns data file format
- `parseBindConfig()`: Parse BIND named.conf
- `generateUnboundConf()`: Generate Unbound configuration
- `generateNsdConf()`: Generate NSD configuration
- `generateNsdConfFromBind()`: Convert BIND to NSD config
- `convertZoneFiles()`: Validate and convert zone files

### Frontend: dns-converter.php

**Location**: `/app/public/tool/dns-converter.php`

**Features**:
- Tab-based interface for two conversion types
- Drag-and-drop file upload
- Real-time conversion progress
- Preview of generated configurations
- Individual file downloads
- Comprehensive error handling

## Security Considerations

### Input Validation
- Archive files are validated before extraction
- Maximum file size limits enforced
- Supported formats checked via MIME type
- Malicious paths prevented during extraction

### Rate Limiting
- Anonymous users: Limited conversions per hour
- Authenticated users: Higher limits
- API key required for production use

### Output Sanitization
- Generated configurations are validated
- No sensitive data exposed in responses
- Temporary files securely cleaned up

## Best Practices

### Before Migration

1. **Backup Current Configuration**
   ```bash
   # djbdns
   tar czf djbdns-backup-$(date +%Y%m%d).tar.gz /var/dnscache/ /var/tinydns/

   # BIND
   tar czf bind-backup-$(date +%Y%m%d).tar.gz /etc/named.conf /var/named/
   ```

2. **Document Current Setup**
   - Note any custom configurations
   - List all managed zones
   - Document zone transfer relationships

3. **Test in Staging**
   - Convert configuration
   - Deploy to test environment
   - Verify DNS resolution
   - Check DNSSEC if enabled

### After Conversion

1. **Review Generated Config**
   - Check all zones are present
   - Verify upstream/forward servers
   - Confirm access control settings
   - Review cache parameters

2. **Test Configuration Syntax**
   ```bash
   # Unbound
   unbound-checkconf unbound.conf

   # NSD
   nsd-checkconf nsd.conf
   ```

3. **Deploy Gradually**
   - Start with test domains
   - Monitor query logs
   - Check for NXDOMAIN errors
   - Verify zone transfers (if applicable)

4. **Update Monitoring**
   - Update monitoring systems
   - Configure alerts
   - Test failover scenarios

## Troubleshooting

### Common Issues

#### djbdns Conversion

**Issue**: "Could not find dnscache directory in archive"
- **Solution**: Ensure archive contains `/var/dnscache/` or `/service/dnscache/` directory structure

**Issue**: No upstream servers found
- **Solution**: Check that `root/servers/` directory contains server files

**Issue**: Cache size is 0m
- **Solution**: Add `CACHESIZE` file to `env/` directory with byte value

#### BIND Conversion

**Issue**: "Could not find named.conf in archive"
- **Solution**: Include `named.conf` in the root of your archive

**Issue**: Zone files not found
- **Solution**: Include zone files with relative paths matching `file` directives in `named.conf`

**Issue**: TSIG keys not converted
- **Solution**: Ensure keys are defined in `named.conf` before zone definitions

### Validation

After conversion, validate your configuration:

```bash
# Unbound validation
unbound-checkconf /etc/unbound/unbound.conf

# NSD validation
nsd-checkconf /etc/nsd/nsd.conf

# Zone file validation
named-checkzone example.com /etc/nsd/zones/example.com.zone
```

## Migration Checklist

- [ ] Backup current DNS server configuration
- [ ] Document all managed zones and settings
- [ ] Create tar.gz archive of configuration
- [ ] Upload and convert configuration
- [ ] Review generated configuration files
- [ ] Validate syntax of generated files
- [ ] Test configuration in staging environment
- [ ] Verify DNS resolution works correctly
- [ ] Check zone transfers (if applicable)
- [ ] Update monitoring and alerting
- [ ] Deploy to production during maintenance window
- [ ] Monitor for errors after deployment
- [ ] Update documentation with new setup

## File Locations

### VeriBits Implementation

- **Controller**: `/app/src/Controllers/DnsConverterController.php`
- **Frontend**: `/app/public/tool/dns-converter.php`
- **Routes**: Registered in `/app/public/index.php`
- **API Endpoints**:
  - POST `/api/v1/dns-converter/dnscache-to-unbound`
  - POST `/api/v1/dns-converter/bind-to-nsd`

### Standard DNS Server Locations

#### djbdns
- Configuration: `/var/dnscache/`, `/service/dnscache/`
- tinydns data: `/var/tinydns/root/data`, `/service/tinydns/root/data`

#### BIND
- Configuration: `/etc/named.conf`, `/etc/bind/named.conf`
- Zones: `/var/named/`, `/etc/bind/zones/`

#### Unbound
- Configuration: `/etc/unbound/unbound.conf`
- Trust anchor: `/var/lib/unbound/root.key`

#### NSD
- Configuration: `/etc/nsd/nsd.conf`
- Zones: `/etc/nsd/zones/`

## Support

For issues or questions about the DNS Migration Converter:

1. Check this documentation
2. Review the troubleshooting section
3. Test in a non-production environment first
4. Contact VeriBits support with:
   - Conversion type (djbdns→Unbound or BIND→NSD)
   - Error messages
   - Sample configuration (sanitized)

## License

© 2025 VeriBits by After Dark Systems. All rights reserved.
