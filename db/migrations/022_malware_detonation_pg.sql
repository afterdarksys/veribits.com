-- Malware Detonation / Sandbox Analysis (PostgreSQL)
-- Migration: 022
-- Description: Add malware analysis and sandbox detonation tables

CREATE TABLE IF NOT EXISTS malware_submissions (
    id SERIAL PRIMARY KEY,
    user_id UUID NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    file_name VARCHAR(255) NOT NULL,
    file_hash VARCHAR(64) NOT NULL,
    file_size BIGINT NOT NULL,
    cuckoo_task_id INTEGER,
    status VARCHAR(50) NOT NULL DEFAULT 'pending',
    priority SMALLINT DEFAULT 1,
    timeout INTEGER DEFAULT 120,
    enable_network BOOLEAN DEFAULT FALSE,
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL
);

CREATE INDEX IF NOT EXISTS idx_malware_submissions_user_id ON malware_submissions(user_id);
CREATE INDEX IF NOT EXISTS idx_malware_submissions_file_hash ON malware_submissions(file_hash);
CREATE INDEX IF NOT EXISTS idx_malware_submissions_status ON malware_submissions(status);
CREATE INDEX IF NOT EXISTS idx_malware_submissions_submitted_at ON malware_submissions(submitted_at);

-- Malware Analysis Results Cache
CREATE TABLE IF NOT EXISTS malware_analysis_results (
    id SERIAL PRIMARY KEY,
    submission_id INTEGER NOT NULL REFERENCES malware_submissions(id) ON DELETE CASCADE,
    score INTEGER,
    threats_detected INTEGER DEFAULT 0,
    signatures_matched TEXT,
    network_activity JSONB,
    file_operations JSONB,
    registry_operations JSONB,
    process_tree JSONB,
    iocs JSONB,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_malware_analysis_results_submission_id ON malware_analysis_results(submission_id);
CREATE INDEX IF NOT EXISTS idx_malware_analysis_results_score ON malware_analysis_results(score);

-- Malware Screenshots
CREATE TABLE IF NOT EXISTS malware_screenshots (
    id SERIAL PRIMARY KEY,
    submission_id INTEGER NOT NULL REFERENCES malware_submissions(id) ON DELETE CASCADE,
    screenshot_path VARCHAR(255) NOT NULL,
    timestamp INTEGER,
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX IF NOT EXISTS idx_malware_screenshots_submission_id ON malware_screenshots(submission_id);
