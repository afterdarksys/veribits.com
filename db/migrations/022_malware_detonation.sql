-- Malware Detonation / Sandbox Analysis
-- Migration: 022
-- Description: Add malware analysis and sandbox detonation tables

CREATE TABLE IF NOT EXISTS malware_submissions (
    id INT AUTO_INCREMENT PRIMARY KEY,
    user_id INT NOT NULL,
    file_name VARCHAR(255) NOT NULL,
    file_hash VARCHAR(64) NOT NULL,
    file_size BIGINT NOT NULL,
    cuckoo_task_id INT,
    status VARCHAR(50) NOT NULL DEFAULT 'pending', -- pending, running, reported, failed
    priority TINYINT DEFAULT 1, -- 1 (low), 2 (medium), 3 (high)
    timeout INT DEFAULT 120,
    enable_network TINYINT(1) DEFAULT 0,
    submitted_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    completed_at TIMESTAMP NULL,
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE,
    INDEX idx_user_id (user_id),
    INDEX idx_file_hash (file_hash),
    INDEX idx_status (status),
    INDEX idx_submitted_at (submitted_at)
);

-- Malware Analysis Results Cache
CREATE TABLE IF NOT EXISTS malware_analysis_results (
    id INT AUTO_INCREMENT PRIMARY KEY,
    submission_id INT NOT NULL,
    score INT, -- Maliciousness score 0-10
    threats_detected INT DEFAULT 0,
    signatures_matched TEXT, -- JSON array of matched signatures
    network_activity JSON, -- Network connections, DNS, HTTP
    file_operations JSON, -- Created, modified, deleted files
    registry_operations JSON, -- Registry changes
    process_tree JSON, -- Process execution tree
    iocs JSON, -- Extracted IOCs (IP, domains, URLs, hashes)
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (submission_id) REFERENCES malware_submissions(id) ON DELETE CASCADE,
    INDEX idx_submission_id (submission_id),
    INDEX idx_score (score)
);

-- Malware Screenshots
CREATE TABLE IF NOT EXISTS malware_screenshots (
    id INT AUTO_INCREMENT PRIMARY KEY,
    submission_id INT NOT NULL,
    screenshot_path VARCHAR(255) NOT NULL,
    timestamp INT, -- Seconds into analysis
    created_at TIMESTAMP DEFAULT CURRENT_TIMESTAMP,
    FOREIGN KEY (submission_id) REFERENCES malware_submissions(id) ON DELETE CASCADE,
    INDEX idx_submission_id (submission_id)
);
